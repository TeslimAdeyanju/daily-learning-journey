# Daily Learning Contribution Workflow
# 
# This workflow automatically generates daily learning logs and updates the repository
# to maintain a consistent contribution history. It runs on a schedule 4 times per day.
#
# IMPORTANT: This workflow handles concurrent runs gracefully by:
# - Checking for changes before committing
# - Pulling and rebasing before pushing to avoid conflicts
# - Retrying push operations if they fail due to concurrent updates
# - Auto-resolving conflicts in generated files (README.md and logs/*.md)
#
# This prevents the "rejected - fetch first" error that occurs when multiple
# scheduled workflow runs execute close together.

name: Daily Learning Contribution

on:
  schedule:
    # Multiple commits throughout the day to look natural
    - cron: "30 8 * * *"   # 8:30 AM UTC (Morning learning)
    - cron: "0 13 * * *"   # 1:00 PM UTC (Lunch break learning)
    - cron: "30 17 * * *"  # 5:30 PM UTC (Evening review)
    - cron: "0 21 * * *"   # 9:00 PM UTC (Night practice)
  workflow_dispatch:

jobs:
  daily-learning:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Generate learning content
        run: |
          echo "Starting daily learning workflow..."
          
          # Create logs directory first
          mkdir -p logs
          
          # Set up variables
          DATE=$(date +%Y-%m-%d)
          TIME=$(date +%H:%M)
          DAY=$(date +%A)
          
          echo "Date: $DATE, Time: $TIME, Day: $DAY"
          
          # Define learning activities
          ACTIVITIES=(
            "Reviewed Python data structures and algorithms"
            "Practiced SQL query optimization techniques"
            "Studied financial modeling best practices"
            "Explored machine learning concepts and applications"
            "Reviewed Power BI dashboard design principles"
            "Practiced Excel VBA automation techniques"
            "Studied cloud computing architecture patterns"
            "Reviewed statistical analysis methods"
            "Explored data visualization best practices"
            "Practiced coding interview problems"
          )
          
          # Pick random activities
          ACTIVITY1=${ACTIVITIES[$RANDOM % ${#ACTIVITIES[@]}]}
          ACTIVITY2=${ACTIVITIES[$RANDOM % ${#ACTIVITIES[@]}]}
          
          echo "Selected activities: $ACTIVITY1, $ACTIVITY2"
          
          # Create learning log entry
          echo "# Daily Learning Log - $DATE" > "logs/$DATE.md"
          echo "" >> "logs/$DATE.md"
          echo "## ðŸ“… $DAY Learning Session - $TIME UTC" >> "logs/$DATE.md"
          echo "" >> "logs/$DATE.md"
          echo "### ðŸŽ¯ Today's Focus:" >> "logs/$DATE.md"
          echo "- $ACTIVITY1" >> "logs/$DATE.md"
          echo "- $ACTIVITY2" >> "logs/$DATE.md"
          echo "- Maintained consistent learning momentum" >> "logs/$DATE.md"
          echo "" >> "logs/$DATE.md"
          echo "### ðŸ“ˆ Progress Notes:" >> "logs/$DATE.md"
          echo "- Continuing professional development journey" >> "logs/$DATE.md"
          echo "- Building strong technical foundation" >> "logs/$DATE.md"
          echo "- Enhancing data analysis capabilities" >> "logs/$DATE.md"
          echo "" >> "logs/$DATE.md"
          echo "---" >> "logs/$DATE.md"
          echo "*Generated at $TIME UTC on $DATE*" >> "logs/$DATE.md"
          
          # Update main README
          echo "# ðŸ“š Daily Learning Journey" > README.md
          echo "" >> README.md
          echo "ðŸŽ¯ **Mission**: Building consistent learning habits and tracking my professional development journey." >> README.md
          echo "" >> README.md
          echo "## ðŸ“Š Recent Learning Activity" >> README.md
          echo "" >> README.md
          echo "**Last Updated**: $DATE at $TIME UTC" >> README.md
          echo "" >> README.md
          echo "### ðŸ”¥ Current Learning Streak: Building daily habits!" >> README.md
          echo "" >> README.md
          echo "### ðŸ“ Latest Learning Session:" >> README.md
          echo "- $ACTIVITY1" >> README.md
          echo "- $ACTIVITY2" >> README.md
          echo "" >> README.md
          echo "## ðŸ—‚ï¸ Learning Logs" >> README.md
          echo "" >> README.md
          echo "All daily learning activities are documented in the [logs/](./logs/) folder." >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "*ðŸ¤– This repository automatically tracks my daily learning activities*" >> README.md
          
          echo "Content generation completed successfully!"

      - name: Commit and push changes
        run: |
          git config --local user.email "teslim@adeyanjuteslim.co.uk"
          git config --local user.name "Teslim Adeyanju"
          git add .
          
          # Create meaningful commit messages based on time
          HOUR=$(date +%H)
          if [ $HOUR -lt 12 ]; then
            MESSAGE="ðŸŒ… Morning learning session - $(date +%Y-%m-%d)"
          elif [ $HOUR -lt 17 ]; then
            MESSAGE="â˜€ï¸ Afternoon study session - $(date +%Y-%m-%d)"
          else
            MESSAGE="ðŸŒ™ Evening learning review - $(date +%Y-%m-%d)"
          fi
          
          echo "Committing with message: $MESSAGE"
          
          # Function to handle rebase conflicts in auto-generated files
          resolve_rebase_conflicts() {
            echo "Attempting to resolve conflicts in auto-generated files..."
            git checkout --ours README.md 2>/dev/null || true
            git add README.md 2>/dev/null || true
            # Safely handle log files using find to avoid wildcard expansion issues
            find logs -name '*.md' -type f -exec git checkout --ours {} \; 2>/dev/null || true
            find logs -name '*.md' -type f -exec git add {} \; 2>/dev/null || true
            git rebase --continue || {
              echo "Could not auto-resolve conflicts"
              git rebase --abort
              return 1
            }
            return 0
          }
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "$MESSAGE"
            
            # Pull and rebase before pushing to handle concurrent workflow runs
            # This prevents push rejection errors when multiple workflows run simultaneously
            echo "Pulling latest changes..."
            git pull --rebase origin main || {
              echo "Rebase failed, attempting to resolve..."
              if ! resolve_rebase_conflicts; then
                echo "Failed to resolve rebase conflicts"
                exit 1
              fi
            }
            
            # Push with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push; then
                echo "Successfully pushed changes!"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                  sleep 2
                  # Pull and rebase again before retry
                  git pull --rebase origin main || {
                    echo "Rebase during retry failed, attempting to resolve..."
                    if ! resolve_rebase_conflicts; then
                      echo "Failed to resolve rebase conflicts during retry"
                      exit 1
                    fi
                  }
                else
                  echo "Failed to push after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi
          
          echo "Workflow completed successfully!"
